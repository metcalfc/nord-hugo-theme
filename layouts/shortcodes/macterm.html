{{- $src := .Get "src" -}}
{{- $poster := .Get "poster" | default "npt:0:00" -}}
{{- $autoplay := .Get "autoplay" | default "false" -}}
{{- $loop := .Get "loop" | default "false" -}}
{{- $speed := .Get "speed" | default "0.8" -}}
{{- $fit := .Get "fit" | default "width" -}}
{{- $cols := .Get "cols" | default "80" -}}
{{- $rows := .Get "rows" | default "24" -}}
{{- $id := printf "asciinema-%d" (now.UnixNano) -}}

<!-- Include the asciinema-player JavaScript and CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/asciinema-player@3.6.3/dist/bundle/asciinema-player.css">
<script src="https://cdn.jsdelivr.net/npm/asciinema-player@3.6.3/dist/bundle/asciinema-player.min.js"></script>

<!-- Mac-styled Terminal Container -->
<div class="mac-term-container">
  <!-- Mac Window Controls -->
  <div class="mac-term-header">
    <div class="mac-controls">
      <span class="mac-control red"></span>
      <span class="mac-control yellow"></span>
      <span class="mac-control green"></span>
    </div>
    <div class="mac-title">Terminal</div>
    <div class="mac-spacer"></div>
  </div>
  
  <!-- Player Container -->
  <div class="mac-term-content">
    <div id="{{ $id }}" class="asciinema-player-container"></div>
  </div>
</div>

<!-- Add required script for this specific player -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded for {{ $id }}');
  const container = document.getElementById('{{ $id }}');
  
  // Define a function to initialize the player
  function initializePlayer() {
    if (typeof AsciinemaPlayer === 'undefined') {
      console.log('AsciinemaPlayer not available yet, waiting...');
      setTimeout(initializePlayer, 300);
      return;
    }
    
    console.log('Initializing AsciinemaPlayer with {{ $src }}');
    
    try {
      // Create the player instance with proper nord-like colors using theme option
      AsciinemaPlayer.create('{{ $src }}', container, {
        poster: '{{ $poster }}',
        autoPlay: {{ $autoplay }},
        loop: {{ $loop }},
        speed: {{ $speed }},
        fit: '{{ $fit }}',
        cols: {{ $cols }},
        rows: {{ $rows }},
        // Use theme option directly
        theme: {
          background: '#2E3440',
          foreground: '#D8DEE9',
          selection: '#434C5E',
          0: '#3B4252',  // black
          1: '#BF616A',  // red
          2: '#A3BE8C',  // green
          3: '#EBCB8B',  // yellow
          4: '#81A1C1',  // blue
          5: '#B48EAD',  // magenta
          6: '#88C0D0',  // cyan
          7: '#E5E9F0',  // white
          8: '#4C566A',  // bright black
          9: '#BF616A',  // bright red
          10: '#A3BE8C', // bright green
          11: '#EBCB8B', // bright yellow
          12: '#81A1C1', // bright blue
          13: '#B48EAD', // bright magenta
          14: '#8FBCBB', // bright cyan
          15: '#ECEFF4'  // bright white
        },
        // Improve font settings
        fontFamily: "SF Mono, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace",
        fontSize: "14px",
        lineHeight: 1.3
      });
      
      console.log('Player created successfully');
      
      // Add window control functionality
      setupWindowControls();
    } catch (error) {
      console.error('Error creating player:', error);
      // Display error message in the container
      container.innerHTML = '<div style="color: #BF616A; padding: 10px;">Error loading terminal recording.</div>';
    }
  }
  
  // Set up window controls
  function setupWindowControls() {
    const macContainer = container.closest('.mac-term-container');
    
    if (macContainer) {
      // Close and minimize buttons
      const redButton = macContainer.querySelector('.mac-control.red');
      const yellowButton = macContainer.querySelector('.mac-control.yellow');
      const greenButton = macContainer.querySelector('.mac-control.green');
      
      if (redButton) {
        redButton.addEventListener('click', function() {
          macContainer.classList.add('minimized');
        });
      }
      
      if (yellowButton) {
        yellowButton.addEventListener('click', function() {
          macContainer.classList.add('minimized');
        });
      }
      
      if (greenButton) {
        greenButton.addEventListener('click', function() {
          if (macContainer.classList.contains('maximized')) {
            // Animate before removing the class
            macContainer.style.animation = 'collapseToCenter 0.25s ease-in-out forwards';
            
            setTimeout(function() {
              macContainer.classList.remove('maximized');
              document.body.style.overflow = '';
              // Reset animation
              macContainer.style.animation = '';
            }, 250);
          } else {
            // Expand
            macContainer.classList.add('maximized');
            document.body.style.overflow = 'hidden';
            // Force a reflow to ensure animation works
            void macContainer.offsetWidth;
          }
        });
      }
      
      // Restore from minimized
      macContainer.addEventListener('click', function(e) {
        if (macContainer.classList.contains('minimized') && 
            !e.target.classList.contains('mac-control')) {
          macContainer.classList.remove('minimized');
        }
      });
      
      // Add ESC key support to exit maximized mode
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && macContainer.classList.contains('maximized')) {
          // Add animation class first
          macContainer.style.animation = 'collapseToCenter 0.25s ease-in-out forwards';
          
          // Then remove maximized class after animation completes
          setTimeout(function() {
            macContainer.classList.remove('maximized');
            document.body.style.overflow = '';
            // Reset animation
            macContainer.style.animation = '';
          }, 250);
        }
      });
    }
  }
  
  // Start the initialization process
  initializePlayer();
});
</script>
